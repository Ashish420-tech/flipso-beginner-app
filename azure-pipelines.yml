trigger:
- main

pool:
  name: Default   # Self-hosted Windows agent

stages:

# =========================
# STAGE 1: CI
# =========================
- stage: CI
  displayName: 'Continuous Integration'
  jobs:
  - job: Build
    displayName: 'Build .NET Application'
    steps:

    - task: UseDotNet@2
      displayName: 'Install .NET SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: dotnet restore
      displayName: 'Restore dependencies'

    - script: dotnet build --no-restore
      displayName: 'Build application'

    - script: dotnet publish -c Release -o $(Build.ArtifactStagingDirectory)
      displayName: 'Publish application'

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Build Artifact'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'drop'


# =========================
# STAGE 2: CD
# =========================
- stage: CD
  displayName: 'Continuous Deployment'
  dependsOn: CI
  condition: succeeded()

  jobs:

  # ---- Manual Approval ----
  - job: Approval
    displayName: 'Manual Approval Gate'
    pool: server
    steps:
    - task: ManualValidation@0
      displayName: 'Approve deployment to Azure'
      inputs:
        instructions: |
          Approve deployment to Azure Web App.
        timeoutInMinutes: 1440


  # ---- Deploy + Verify ----
  - job: Deploy
    displayName: 'Deploy and Verify Application'
    dependsOn: Approval
    steps:

    - download: current
      artifact: drop

    # ---- ZIP & DEPLOY ----
    - task: AzureCLI@2
      displayName: 'Deploy artifact using Azure CLI'
      inputs:
        azureSubscription: 'Azure-Flipso-CD'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          Write-Host "Preparing ZIP package..."

          $zipPath = "$(Pipeline.Workspace)\app.zip"
          $sourcePath = "$(Pipeline.Workspace)\drop\*"

          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }

          Compress-Archive -Path $sourcePath -DestinationPath $zipPath

          Write-Host "Deploying to Azure Web App..."

          az webapp deploy `
            --resource-group rg-flipso-cd `
            --name flipso-cd-app-ashish `
            --src-path $zipPath `
            --type zip

          Write-Host "Deployment completed."


    # ---- HEALTH CHECK ----
    - powershell: |
        Write-Host "Waiting for application to warm up..."
        Start-Sleep -Seconds 15

        $healthUrl = "https://flipso-cd-app-ashish.azurewebsites.net/health"
        Write-Host "Checking health endpoint: $healthUrl"

        try {
          $response = Invoke-WebRequest -Uri $healthUrl -UseBasicParsing -TimeoutSec 30
          if ($response.StatusCode -eq 200 -and $response.Content -match "Healthy") {
            Write-Host "✅ Application is HEALTHY"
          } else {
            Write-Error "❌ Health check failed"
            exit 1
          }
        }
        catch {
          Write-Error "❌ Health check request failed"
          exit 1
        }
      displayName: 'Verify application health'


trigger:
- main

pool:
  name: Default

stages:
# =========================
# STAGE 1: CI
# =========================
- stage: CI
  displayName: 'Continuous Integration'
  jobs:
  - job: Build
    displayName: 'Build Application'
    steps:
    - task: UseDotNet@2
      displayName: 'Use .NET SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: dotnet restore
      displayName: 'Restore dependencies'

    - script: dotnet build --no-restore
      displayName: 'Build application'

    - script: dotnet publish -c Release -o $(Build.ArtifactStagingDirectory)
      displayName: 'Publish build output'

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'drop'

# =========================
# STAGE 2: CD
# =========================
- stage: CD
  displayName: 'Continuous Deployment'
  dependsOn: CI
  condition: succeeded()
  jobs:

  # ---- Manual Approval ----
  - job: Approval
    displayName: 'Manual Approval Gate'
    pool: server
    steps:
    - task: ManualValidation@0
      displayName: 'Approve Deployment'
      inputs:
        instructions: |
          Please review the CI build and approve deployment to Azure Web App.
        timeoutInMinutes: 1440

  # ---- Deploy using Azure CLI ----
  - job: Deploy
    displayName: 'Deploy to Azure Web App using CLI'
    dependsOn: Approval
    steps:
    - download: current
      artifact: drop

    - task: AzureCLI@2
      displayName: 'Deploy artifact to Azure Web App'
      inputs:
        azureSubscription: 'Azure-Flipso-CD'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "Starting deployment to Azure Web App..."
          az webapp deploy \
            --resource-group rg-flipso-cd \
            --name flipso-cd-app-ashish \
            --src-path $(Pipeline.Workspace)/drop \
            --type zip
          echo "Deployment completed."
